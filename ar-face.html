<!DOCTYPE html>
<html>
<head>
    <title>Mira Face Filter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-ar/dist/aframe-ar.min.js"></script>
    
    <style>
        body { margin: 0; }
        .ar-ui-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 1000;
            color: white;
            font-family: sans-serif;
            background-color: rgba(0,0,0,0.7);
            flex-direction: column;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loader" class="ar-ui-container">
        <h1><i class="fas fa-camera"></i> Starting Camera...</h1>
        <p>Please grant camera permissions.</p>
    </div>

    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; trackingMethod: best' vr-mode-ui="enabled: false">
      
        <a-entity id="face-tracker" ar-face-tracking>
            </a-entity>
      
        <a-camera user-camera></a-camera>
    </a-scene>

    <script type="module">
        import './ar-data.js'; // Ensure this path is correct

        const loader = document.getElementById('loader');
        const scene = document.querySelector('a-scene');
        const faceTracker = document.getElementById('face-tracker');

        async function initializeFaceFilter() {
            try {
                const params = new URLSearchParams(window.location.search);
                const experienceId = params.get('id');
                if (!experienceId) throw new Error("No Experience ID found.");

                const exp = await window.MiraData.getExperience(experienceId);
                if (!exp || exp.type !== 'face') throw new Error("Experience is not a face filter.");
                
                const modelEntity = document.createElement('a-gltf-model');
                modelEntity.setAttribute('src', exp.fileUrls[0].url);

                // --- CRITICAL ---
                // Every 3D model is different. You MUST adjust position, rotation, and scale
                // here to make the filter fit correctly on a face.
                // These are example values that might work for a glasses model.
                modelEntity.setAttribute('position', '0 0.1 -0.5'); // X Y Z from face center
                modelEntity.setAttribute('rotation', '0 0 0');
                modelEntity.setAttribute('scale', '1.2 1.2 1.2');
                // --- END CRITICAL ---
                
                faceTracker.appendChild(modelEntity);

            } catch (error) {
                loader.innerHTML = `<h1>Error: ${error.message}</h1>`;
                console.error("Face Filter Initialization Error:", error);
            }
        }

        scene.addEventListener('loaded', () => {
            loader.classList.add('hidden');
            initializeFaceFilter();
        });
    </script>
</body>
</html>
