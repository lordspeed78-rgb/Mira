<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Experiences - Mira</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container fade-in-up">
        <header class="header">
            <h1 class="logo">Mira</h1>
            <i id="hamburger-icon" class="fas fa-bars hamburger"></i>
            <nav>
                <ul id="nav-menu" class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="dashboard.html">My Experiences</a></li>
                    <li><a href="#" id="sign-out-btn">Sign Out</a></li>
                </ul>
            </nav>
        </header>

        <main>
            <h2>My Experiences</h2>
            <div id="experiences-list" class="experience-grid">
                </div>
            <div class="empty-state hidden" id="empty-state">
                <i class="fas fa-box-open"></i>
                <h3>Nothing here yet!</h3>
                <p>Create your first AR experience from the home page.</p>
                <a href="index.html" class="btn btn-primary">Create New</a>
            </div>
        </main>
    </div>
    
    <script type="module">
        import { auth } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import './ar-data.js';

        document.addEventListener('DOMContentLoaded', () => {
            const experiencesList = document.getElementById('experiences-list');
            const emptyState = document.getElementById('empty-state');
            const signOutBtn = document.getElementById('sign-out-btn');
            const hamburgerIcon = document.getElementById('hamburger-icon');
            const navMenu = document.getElementById('nav-menu');

            // --- Auth & Nav Logic ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    loadExperiences();
                } else {
                    window.location.href = 'get-started.html';
                }
            });

            signOutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                await signOut(auth);
            });
            
            hamburgerIcon.addEventListener('click', () => {
                navMenu.classList.toggle('active');
            });

            // --- Data Loading & Rendering ---
            async function loadExperiences() {
                const experiences = await MiraData.getAllExperiences();
                renderExperiences(experiences);
            }

            function renderExperiences(experiences) {
                experiencesList.innerHTML = '';
                if (experiences.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }
                emptyState.classList.add('hidden');

                experiences.forEach(exp => {
                    const card = document.createElement('div');
                    card.className = 'experience-card';
                    
                    const iconClass = {
                        text: 'fa-font',
                        model: 'fa-cube',
                        video: 'fa-video',
                        portal: 'fa-dungeon',
                        face: 'fa-smile'
                    }[exp.type] || 'fa-question-circle';
                    
                    card.innerHTML = `
                        <div class="card-header">
                           <i class="fas ${iconClass}"></i>
                           <h3>${exp.fileName}</h3>
                        </div>
                        <p class="card-meta">Type: ${exp.type.toUpperCase()}</p>
                        <p class="card-meta">Created: ${new Date(exp.createdAt.seconds * 1000).toLocaleDateString()}</p>
                        <div class="card-actions">
                            <button class="btn" onclick="viewExperience('${exp.id}', '${exp.type}')"><i class="fas fa-eye"></i> View</button>
                            <button class="btn btn-delete" onclick="deleteExperience('${exp.id}')"><i class="fas fa-trash"></i> Delete</button>
                        </div>
                    `;
                    experiencesList.appendChild(card);
                });
            }

            window.viewExperience = function(id, type) {
                const targetPage = type === 'face' ? 'ar-face.html' : 'ar.html';
                window.open(`${targetPage}?id=${id}`, '_blank');
            };

            window.deleteExperience = async function(id) {
                if (confirm('Are you sure you want to delete this experience?')) {
                    try {
                        await MiraData.deleteExperience(id);
                        loadExperiences(); // Refresh the list
                    } catch(error) {
                        alert("Error deleting experience: " + error.message);
                    }
                }
            };
        });
    </script>
</body>
</html>
